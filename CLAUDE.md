# JuegoCoches - Claude Code Instructions

> **IMPORTANT**: This is a Next.js project. Ignore any inherited `.ruler/` instructions about Angular, Ionic, or Capacitor — those belong to a different project.

## Tech Stack

- **Framework**: Next.js 16 (App Router, Server Components, Server Actions)
- **Language**: TypeScript (strict mode)
- **UI**: React 19, Tailwind CSS 4, Framer Motion
- **Auth**: Supabase Auth (email/password + Google OAuth)
- **Database**: PostgreSQL via Prisma 7 ORM (hosted on Supabase)
- **Package Manager**: pnpm
- **Realtime**: Supabase Realtime (client-side subscriptions)
- **Validation**: Zod v4 with sanitization transforms
- **AI Moderation**: OpenRouter API (LLM-based, fail-closed)
- **Notifications**: Sonner (toasts)

## Project Structure

```
src/
  actions/       — Server Actions ("use server"), one file per domain
  app/           — App Router: pages and layouts
    page.tsx     — Landing page (/ — two buttons: Game and Poll)
    (auth)/      — Auth route group (login, register)
    auth/        — Auth API routes (OAuth callback, email confirm)
    poll/        — Polling system (/poll)
      page.tsx   — Main poll page (ideas and game proposals)
      proponer/  — Propose daily improvements (/poll/proponer)
      proponer-juego/ — Propose games (/poll/proponer-juego)
  components/    — React components organized by feature
    ui/          — Reusable UI primitives (Card, Badge, Button, Input)
  hooks/         — Client-side hooks (useRealtimeIdeas, useUser, useCountdown)
  lib/           — Shared utilities
    supabase/    — Supabase clients (client.ts, server.ts, middleware.ts)
  types/         — TypeScript type definitions
prisma/          — Prisma schema
supabase/
  migrations/    — SQL migrations (RLS, triggers, etc.)
```

## Architectural Patterns

### Server Actions
All follow an 8-step pattern and return `ActionResult<T>`:
1. Auth (`requireAuth()`)
2. Time window check (`isBeforeMadridNoon()` / `isGameVotingOpen()`)
3. Rate limit (`checkRateLimit()`)
4. Zod validation (with `sanitizeHtml` transforms)
5. Daily limit check (Prisma uniqueness query)
6. AI moderation (if applicable)
7. DB write (Prisma)
8. `revalidatePath("/poll")`

### Components
- **Server Components** by default. Only add `"use client"` when React hooks or browser APIs are needed.
- Sensitive data never reaches the client.

### Dates and Timezone
- **ALL** time-related logic uses `Europe/Madrid` timezone via `src/lib/dates.ts`.
- Do not use `new Date()` directly for business logic — use the project's date utilities.

### Database
- Prisma maps camelCase (TS) to snake_case (PostgreSQL) via `@map()`.
- IDs are UUIDs generated by PostgreSQL (`gen_random_uuid()`).
- Vote counting is handled by **PostgreSQL triggers**, not application code.
- Unique constraints (`@@unique`) act as a safety net against race conditions.

## Security Rules

### Secrets and API Keys
- **NEVER** commit `.env`, `.env.local`, or any file containing real credentials.
- Use `.env.example` as a reference for contributors.
- All environment variables are validated at startup via `src/lib/env.ts`.
- `SUPABASE_SERVICE_ROLE_KEY` bypasses RLS — only use it server-side when strictly necessary.

### User Input
- All input goes through Zod schemas with `sanitizeHtml()` (entity encoding) before storage.
- `sanitizeHtml()` lives in `src/lib/security.ts` — HTML entity encoding, suitable for plain-text fields.
- UUIDs are validated with `z.string().uuid()` to prevent SQL injection via IDs.

### AI Moderation
- User content is delimited with `<contenido_usuario>` XML tags in prompts.
- XML tags are stripped from user input (`stripXmlTags()`) before interpolation.
- The system prompt explicitly instructs the LLM to ignore user-provided instructions.
- AI responses are validated with Zod (`ModerationResultSchema`).
- Categories are validated against an allow-list.
- The `motivo` field is sanitized with `sanitizeHtml()` and truncated to 500 chars.
- **Fail-closed**: any error results in rejection (`approved: false`).

### Rate Limiting
- In-memory implementation (`Map`) in `src/lib/rate-limit.ts`.
- **Known limitation**: does not persist across serverless instances. DB constraints act as a fallback.
- Per-action limits: `submitIdea` (3/min), `castVote` (5/10s), `moderationApi` (3/day).

### Middleware and Protected Routes
- Authenticated routes are explicitly defined in `src/lib/supabase/middleware.ts`.
- When adding a new protected route, add it to the `protectedPaths` array.
- Auth uses `supabase.auth.getUser()` (validates JWT server-side), not `getSession()`.

## Commands

```bash
pnpm dev             # Development server
pnpm build           # Production build
pnpm start           # Start production server
pnpm lint            # ESLint
npx prisma generate  # Regenerate Prisma client
npx prisma db push   # Push schema to DB
```

## Code Conventions

- Path alias: `@/*` maps to `./src/*`
- Tailwind for all styling, no CSS modules
- No `any` types — use proper typing
- User-facing error messages in **Spanish**, console logs in English
- Imports: external libraries first, then `@/` internal imports
